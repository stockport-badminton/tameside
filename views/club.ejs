<%- include('header.ejs') %>
<%- include('nav.ejs') %>

<% if (error) { %>
  <div class="container my-5">
    <div class="alert alert-danger" role="alert">
      <i class="fas fa-triangle-exclamation"></i> <strong>Something went wrong</strong>
      <p class="mb-0 mt-2"><%= error %></p>
    </div>
  </div>
<% } else { %>

<!-- Page Header -->
<section class="hero" style="padding: 4rem 2rem 3rem;">
  <h1><i class="fas fa-users"></i> Clubs</h1>
  <p>Find your local badminton club in the Tameside league</p>
</section>

<!-- Map Section -->
<section class="section" style="padding-top: 2rem;">
  <div class="container">
    <div id="map" style="height: 400px; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); overflow: hidden; margin-bottom: 3rem;"></div>
  </div>
</section>

<!-- Clubs Grid -->
<section class="section" style="background: white; padding: 3rem 0;">
  <div class="container">
    <h2 class="section-title">
      <i class="fas fa-building"></i> Club Directory
    </h2>
    
    <div class="clubs-grid">
      <% result.forEach(function(row){ 
        if (row['id'] != 63) { %>
        
        <div class="club-card">
          <!-- Club Header -->
          <div class="club-header">
            <h3 class="club-name">
              <% if (row['clubWebsite'] != ''){ %>
                <a href="<%= row['clubWebsite'] %>" target="_blank">
                  <%= row['name'] %> <i class="fas fa-arrow-up-right-from-square"></i>
                </a>
              <% } else { %>
                <%= row['name'] %>
              <% } %>
            </h3>
          </div>

          <!-- Club Info Grid -->
          <div class="club-info">
            <!-- Contact -->
            <div class="info-item">
              <div class="info-label">
                <i class="fas fa-envelope"></i> Contact
              </div>
              <div class="info-content">
                <button type="button" class="btn-modern-primary btn-sm openForm" 
                        data-bs-toggle="modal" 
                        data-bs-target="#exampleModal" 
                        data-club="<%= row['id'] %>">
                  <i class="fas fa-paper-plane"></i> Get in touch
                </button>
                <div class="mt-2">
                  <a href="/club/<%= row['id'] %>" class="text-muted" style="font-size: 0.9rem;">
                    <i class="fas fa-lock"></i> Login for contact info
                  </a>
                </div>
              </div>
            </div>

            <!-- Match Details -->
            <div class="info-item">
              <div class="info-label">
                <i class="fas fa-calendar"></i> Match Details
              </div>
              <div class="info-content">
                <% if (row.teams.length > 1){ 
                  for (team of row.teams){ %>
                    <div class="team-info">
                      <strong><%= team.name %>:</strong><br />
                      <a href="<%= team.gMapURL %>" target="_blank" class="venue-link">
                        <i class="fas fa-location-dot"></i> <%= team.address %>
                      </a><br />
                      <span class="text-muted"><%= team.matchDay %></span>
                    </div>
                  <% } %>
                <% } else { %>
                  <div class="team-info">
                    <strong>All Teams:</strong><br />
                    <a href="<%= row.teams[0].gMapURL %>" target="_blank" class="venue-link">
                      <i class="fas fa-location-dot"></i> <%= row.teams[0].address %>
                    </a><br />
                    <span class="text-muted"><%= row.teams[0].matchDay %></span>
                  </div>
                <% } %>
              </div>
            </div>

            <!-- Club Night -->
            <div class="info-item">
              <div class="info-label">
                <i class="fas fa-clock"></i> Club Night
              </div>
              <div class="info-content">
                <%= row['clubNightText'] %>
              </div>
            </div>

            <!-- Main Venue -->
            <div class="info-item">
              <div class="info-label">
                <i class="fas fa-map-marker-alt"></i> Main Venue
              </div>
              <div class="info-content">
                <a href="<%= row['gMapUrl'] %>" target="_blank" class="venue-link">
                  <i class="fas fa-location-dot"></i> <%= row['address'] %>
                </a>
              </div>
            </div>

            <!-- Admin Link (if applicable) -->
            <% if (typeof user !== 'undefined' && user['_json']['https://my-app.example.com/role'] == "superadmin") { %>
              <div class="info-item">
                <div class="info-label">
                  <i class="fas fa-user-gear"></i> Admin
                </div>
                <div class="info-content">
                  <a href="/manage-players/club-<%= row['name'] %>" class="btn-modern-secondary btn-sm">
                    <i class="fas fa-users-gear"></i> Manage Players
                  </a>
                </div>
              </div>
            <% } %>
          </div>
        </div>
        
      <% }
      }) %>
    </div>
  </div>
</section>

<% } %>

<!-- Contact Modal -->
<div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">
          <i class="fas fa-envelope"></i> Get in touch with 
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form role="form" id="contactUs" action="/contact-us" method="post">
        <div class="modal-body">
          <input type="hidden" value="" id="clubSelect" name="clubSelect" />
          <input type="hidden" value="Clubs" id="contactType" name="contactType" />

          <div class="mb-3">
            <label for="contactEmail" class="form-label">
              <i class="fas fa-envelope"></i> Email address
            </label>
            <input type="email" class="form-control" id="contactEmail" name="contactEmail" 
                   placeholder="your.email@example.com" required>
            <small class="form-text text-muted">We'll never share your email with anyone else.</small>
          </div>
          
          <div class="mb-3">
            <label for="contactQuery" class="form-label">
              <i class="fas fa-message"></i> Your message
            </label>
            <textarea class="form-control" id="contactQuery" name="contactQuery" 
                      rows="5" placeholder="Type your message here..." required></textarea>
          </div>
          
          <div class="mb-3">
            <div class="g-recaptcha" data-sitekey="<%= recaptcha %>"></div>
          </div>
        </div>
        
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="fas fa-times"></i> Close
          </button>
          <button type="submit" class="btn-modern-primary">
            <i class="fas fa-paper-plane"></i> Send Message
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<%- include('footer.ejs') %>

<script>
// Initialize and add the map
function initMap() {
  var StockportTownHall = {lat:53.4060787, lng:-2.1606755};
  var map = new google.maps.Map(
    document.getElementById('map'), 
    {
      zoom: 10, 
      center: StockportTownHall, 
      mapId: '28eeb908f19e8aab'
    }
  );
  
  var data = <%- venues %>
  
  data.forEach(function(i){
    if (i.Lat != null){
      var point = {lat: i.Lat, lng: i.Lng}
      
      var contentString = '<div id="content">' +
        '<div id="siteNotice"></div>' + 
        i.venueInfoBox + 
        '</div>';

      var infowindow = new google.maps.InfoWindow({
        content: contentString
      });
      
      var clubMarker = new google.maps.marker.AdvancedMarkerElement({
        position: point, 
        map: map
      });
      
      clubMarker.addListener('click', function() {
        infowindow.open(map, clubMarker);
      });
    }
  })
}
</script>

<script src="//maps.googleapis.com/maps/api/js?key=<%= mapsApiKey %>&libraries=marker&callback=initMap&loading=async" async defer></script>
<script src="//www.google.com/recaptcha/api.js" async defer></script>

<script type="text/javascript">
  $(document).ready(function(){
    $('.openForm').click(function(){
      var clubName = $(this).attr('data-club')
      $('#exampleModalLabel').html('<i class="fas fa-envelope"></i> Get in touch with ' + clubName)
      $('#clubSelect').val(clubName)
    })
  })
</script>

</body>
</html>