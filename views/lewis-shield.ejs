<%- include('header.ejs') %>
<%- include('nav.ejs') %>

<!-- Page Header -->
<section class="hero" style="padding: 4rem 2rem 3rem;">
  <h1><i class="fas fa-shield-halved"></i> Lewis Shield Draw</h1>
  <p>Tournament knockout bracket</p>
</section>

<!-- Tournament Bracket -->
<section class="bracket-section">
  <div class="container-fluid">
    <div class="tournament-bracket">
      <% 
      let fixCount = 0
      let offset = 0
      let prelims = teams[1].prelims.split(",")
      let preLimnumbers = prelims.map(row => parseInt(row))
      let bracketsOffset = preLimnumbers.length % 2
      
      const roundNames = ['Prelim','Round 1', 'Quarter Finals', 'Semi Finals', 'Final']
      
      for (let i = 0; i < 4; i++) { %>
        <div class="bracket-round" data-round="<%= i + 1 %>">
          <h3 class="round-title"><%= roundNames[i] %></h3>
          <div class="round-matches">
            <%
            for (let j = 0; j < 16; j++) { 
              if (j % Math.pow(2, i) == 0) { 
                if (i == 0) {
                  // First round with prelims
                  if (preLimnumbers.includes(j)) { 
                    fixCount++
                    %>
                    <div class="match-wrapper">
                      <% if (typeof teams[fixCount + offset] !== 'undefined') { %>
                        <div class="match-card <%= teams[fixCount + offset].homeScore != null ? 'completed' : 'pending' %>">
                          <div class="match-header">
                            <span class="match-number">Match <%= fixCount %></span>
                            <% if (teams[fixCount + offset].homeScore != null) { %>
                              <span class="match-status completed">
                                <i class="fas fa-check-circle"></i> Complete
                              </span>
                            <% } else { %>
                              <span class="match-status pending">
                                <i class="far fa-clock"></i> Pending
                              </span>
                            <% } %>
                          </div>
                          <div class="match-teams">
                            <div class="team <%= teams[fixCount + offset].homeScore != null && teams[fixCount + offset].homeScore > teams[fixCount + offset].awayScore ? 'winner' : '' %>">
                              <span class="team-name"><%= teams[fixCount + offset].homeTeam %></span>
                              <% if (teams[fixCount + offset].homeScore != null) { %>
                                <span class="team-score"><%= teams[fixCount + offset].homeScore %></span>
                              <% } %>
                            </div>
                            <div class="team <%= teams[fixCount + offset].homeScore != null && teams[fixCount + offset].awayScore > teams[fixCount + offset].homeScore ? 'winner' : '' %>">
                              <span class="team-name"><%= teams[fixCount + offset].awayTeam %></span>
                              <% if (teams[fixCount + offset].homeScore != null) { %>
                                <span class="team-score"><%= teams[fixCount + offset].awayScore %></span>
                              <% } %>
                            </div>
                          </div>
                        </div>
                      <% } %>
                      <div class="connector"></div>
                    </div>
                                      <% } else { %>
                    <div class="match-wrapper spacer">
                      <div class="match-card" style="visibility: hidden;">
                        <div class="match-header"><span class="match-number">-</span></div>
                        <div class="match-teams">
                          <div class="team"><span class="team-name">-</span></div>
                          <div class="team"><span class="team-name">-</span></div>
                        </div>
                      </div>
                    </div>
                  <% }
                } else { 
                  // Later rounds
                  fixCount++
                  %>
                  <div class="match-wrapper">
                    <% if (typeof teams[fixCount + offset] !== 'undefined') { %>
                      <div class="match-card <%= teams[fixCount + offset].homeScore != null ? 'completed' : 'pending' %>">
                        <div class="match-header">
                          <span class="match-number">Match <%= fixCount %></span>
                          <% if (teams[fixCount + offset].homeScore != null) { %>
                            <span class="match-status completed">
                              <i class="fas fa-check-circle"></i> Complete
                            </span>
                          <% } else { %>
                            <span class="match-status pending">
                              <i class="far fa-clock"></i> Pending
                            </span>
                          <% } %>
                        </div>
                        <div class="match-teams">
                          <div class="team <%= teams[fixCount + offset].homeScore != null && teams[fixCount + offset].homeScore > teams[fixCount + offset].awayScore ? 'winner' : '' %>">
                            <span class="team-name"><%= teams[fixCount + offset].homeTeam %></span>
                            <% if (teams[fixCount + offset].homeScore != null) { %>
                              <span class="team-score"><%= teams[fixCount + offset].homeScore %></span>
                            <% } %>
                          </div>
                          <div class="team <%= teams[fixCount + offset].homeScore != null && teams[fixCount + offset].awayScore > teams[fixCount + offset].homeScore ? 'winner' : '' %>">
                            <span class="team-name"><%= teams[fixCount + offset].awayTeam %></span>
                            <% if (teams[fixCount + offset].homeScore != null) { %>
                              <span class="team-score"><%= teams[fixCount + offset].awayScore %></span>
                            <% } %>
                          </div>
                        </div>
                      </div>
                    <% } %>
                    <div class="connector"></div>
                  </div>
                <% } 
              } 
            } %>
          </div>
        </div>
      <% } %>
    </div>

    <!-- Champion Display -->
    <% 
    // Find the final match (last in the array)
    let finalMatch = teams[teams.length - 1]
    if (finalMatch && finalMatch.homeScore != null) {
      let champion = finalMatch.homeScore > finalMatch.awayScore ? finalMatch.homeTeam : finalMatch.awayTeam
    %>
    <div class="champion-section">
      <div class="champion-card">
        <div class="trophy-icon">
          <i class="fas fa-trophy"></i>
        </div>
        <h2>Champion</h2>
        <h3><%= champion %></h3>
        <p class="score-display">
          <%= finalMatch.homeTeam %> <%= finalMatch.homeScore %> - <%= finalMatch.awayScore %> <%= finalMatch.awayTeam %>
        </p>
      </div>
    </div>
    <% } %>
  </div>
</section>

<%- include('footer.ejs') %>

<script>
  // Store teams data for potential future use
  const teamsData = <%- JSON.stringify(teams) %>;
  console.log('Lewis Shield Teams:', teamsData);
</script>

</body>
</html>